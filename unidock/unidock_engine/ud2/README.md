# UD2

Uni-Dock 2.0 C++ engine, working together with Uni-Dock Tools (udtools) .

This document serves for Developers, not users.

## Requirements
* CUDA 12.*
* CUDA Architecture 60+ 


## How to compile it
### 1. Install CUDA via Conda
```shell
mamba install -c conda-forge cudatoolkit
```

### 2. Perform compilation
#### If cuda is installed via conda 
```shell
mkdir build
cd build
cmake .. -DCONDA_PREFIX=/home/miniconda3/your_env -DCMAKE_BUILD_TYPE=Release
make -j10
```
Then the binary `ud2` will be found under `build/bin` directory

#### If cuda is installed by other means
Since the compilation CMakeLists.txt files suppose a conda environment, pls modify them accordingly.

For example, Please modify these two lines in the root `CMakeLists.txt`
```cmake
set(CUDAToolkit_ROOT ${CONDA_PREFIX}/bin)
set(CMAKE_CUDA_COMPILER ${CONDA_PREFIX}/bin/nvcc)
```
Then perform compilation as illustrated above.


## How to run it
The input you should prepare is a config.yaml file, definition of which can be found 
in template file `ud2/data/config.yaml`.

As illustrated in the yaml file, you should also prepare a json file containing the 
receptor & ligands info, which can be generated by **UniDock-Tools**.

### Example
```shell
cd ud2/test/data/dev1
../../../build/bin/ud2 config.yaml
```

### Different Pre-defined Tasks
Several typical tasks are defined, and you can easily apply them by setting `congfig.yaml`:
```shell
...
Settings:
  task: !!str screen # screen | score | mc
...
```
Explaination of pre-defined tasks:

#### screen
Perform standard docking tasks, where ONE receptor and some(>0) ligands are provided. 
For each ligand, `Advanced->exhaustiveness` MC searching tasks will finally generate 
`Advanced->exhaustiveness` poses. After clustered according to `Advanced->rmsd_limit`,
the best `Advanced->num_pose` poses withing the `Advanced->energy_range` kcal/mol
will be output to the result json file, along with their energy terms.

The **energy terms** of one pose is a list of floats, namely `[Predicted Free Energy of Affinity, 
Total Score, Intra-molecular Score, Inter-molecular Score, Conformation-independent Score, 
Penalty Score]`.

#### score
Just provide score for the current pose of each providing ligand. No 
randomization/searching/optimization/clustering/filtering will be performed.
Only the given pose and its energy terms will be saved to the result json file.

#### mc
Only perform Monte Carlo searching to find the best poses. It is usually used to test the 
sampling ability of MC process. In this task, after randomization, the metropolis MC will 
be performed without optimization of each pose. 
clustering/filtering will still be performed.
No refinement.

#### benchmark
This is a convenient way to perform benchmark test to check the correctness and speed of UD2.
By given many receptor&best_ligand_pose data, UD2 will first perform "screen" task to find the 
best `num_pose` poses and record their predicted affinity and RMSD from the expected best pose,
along with the total time cost.

Users could perform further analysis based on these data.

#### FREE Task
If the pre-defined tasks can't meet your need, pls use `screen` as the task type, and change
detailed settings in `Advanced` as you like, since all provided parameters will take effect for 
`screen` task.


## Source Code Illustration
* **src** Contains basic source code files.
* **test** Includes unit tests and component tests.
* **bin** Stores published functional binaries for users.
* **doc** Provides Doxygen-generated documents.
* **lib** Contains third-party static libraries (not modified from source) built for this project.
* **include** Contains third-party header files.
* **cmake** Includes settings for the build system.
* **set_env.sh** An easy-to-use shell script for developers to quickly set up a ready-to-use development environment.
* **api** [Not Loaded] Provides APIs for other languages like python, front-end (Node.js).
* **scripts** [Not Loaded] Provides easy-to-use scripts for users to run standard docking processes, requiring no understanding of the coding details.


## Notes
* Upper Triangular Matrix is utilized to save symmetrical matrix.
* Atomic forces should be transferred to molecular rotation and dihedral changes, including Vina and FF
* 

## TODO & BUGS
- [x] ignore all hydrogen atoms 
- [ ] Solve: topo.vn_types duplicate with flex_param.atom_types
- [x] Terminal stream should also change to spdlog
- [x] Add re-score functionality
- [x] Dump all energy terms
- [x] Apply penalty force (now only energy)
- [x] Add predict memory
- [ ] Add clash detection (don't be too strict, since the initial pose may be improved through mutation or optimization)
- [x] Dump detailed energy terms
- [x] Add version info
- [ ] Automatically Adjust n according to box size 
